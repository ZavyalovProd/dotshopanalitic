const API="https://api.dotinfo.com.ru/api";let period="week",token=null,isAdmin=!1,data=null,allOrders=[],reviewerIds=new Set,filterPay="all";function loader(){const e=document.getElementById("loader-status"),t=["Initializing...","Connecting...","Loading...","Welcome!"];let n=0;const o=setInterval(()=>{n<t.length?e.textContent=t[n++]:(clearInterval(o),setTimeout(()=>{document.getElementById("loader").classList.add("hide"),checkAuth()},300))},400)}function checkAuth(){const e=localStorage.getItem("dotshop_token");e?(token=e,verify()):showLogin()}function showLogin(){document.getElementById("login").classList.add("show")}async function verify(){try{const e=await fetch(API+"/auth",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:token})}),t=await e.json();t.success?(isAdmin=!0===t.is_admin,showDash()):(localStorage.removeItem("dotshop_token"),showLogin())}catch{showLogin()}}async function login(){const e=document.getElementById("inp-token").value.trim();if(!e)return err("Enter token");try{const t=await fetch(API+"/auth",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})}),n=await t.json();n.success?(token=e,isAdmin=!0===n.is_admin,localStorage.setItem("dotshop_token",e),document.getElementById("login").classList.remove("show"),showDash()):err(n.error||"Invalid token")}catch{err("Connection error")}}function logout(){localStorage.removeItem("dotshop_token"),token=null,isAdmin=!1;document.getElementById("dash").classList.remove("show","admin"),document.querySelectorAll(".admin-nav").forEach(e=>e.classList.add("hide")),showLogin()}function showDash(){const e=document.getElementById("dash");e.classList.add("show"),!0===isAdmin?(e.classList.add("admin"),document.querySelectorAll(".admin-nav").forEach(e=>e.classList.remove("hide"))):(e.classList.remove("admin"),document.querySelectorAll(".admin-nav").forEach(e=>e.classList.add("hide"))),fetchStats(),fetchReviews()}function err(e){const t=document.getElementById("error");t.textContent=e,setTimeout(()=>t.textContent="",3e3)}function showAdminForm(){document.getElementById("form-token").classList.add("hide"),document.getElementById("form-pass").classList.remove("hide")}function backToToken(){document.getElementById("form-pass").classList.add("hide"),document.getElementById("form-code").classList.add("hide"),document.getElementById("form-token").classList.remove("hide")}async function sendCode(){const e=document.getElementById("inp-pass").value.trim();if(!e)return err("Enter password");try{const t=await fetch(API+"/admin/request-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:e})}),n=await t.json();n.success?(document.getElementById("form-pass").classList.add("hide"),document.getElementById("form-code").classList.remove("hide")):err(n.error||"Error")}catch{err("Connection error")}}async function verifyCode(){const e=document.getElementById("inp-code").value.trim();if(!e)return err("Enter code");try{const t=await fetch(API+"/admin/verify-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e})}),n=await t.json();n.success?(token=n.admin_token,isAdmin=!0,localStorage.setItem("dotshop_token",token),document.getElementById("login").classList.remove("show"),showDash()):err(n.error||"Invalid code")}catch{err("Connection error")}}function setConn(e){const t=document.getElementById("conn");t.className="conn "+e,t.querySelector(".txt").textContent="on"===e?"Connected":"wait"===e?"Connecting...":"Offline"}async function fetchStats(){if(token){setConn("wait");try{const e=await fetch(API+"/stats?period="+period,{headers:{Authorization:"Bearer "+token}});if(!e.ok)throw 0;data=await e.json(),allOrders=data.recent_orders||[],setConn("on"),document.getElementById("upd").textContent="Updated: "+(new Date).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}),updatePaymentFilter(data.payment_methods||{}),render()}catch{setConn("")}}}async function fetchReviews(){if(token)try{const e=await fetch(API+"/reviews",{headers:{Authorization:"Bearer "+token}}),t=await e.json();t.reviewer_ids&&(reviewerIds=new Set(t.reviewer_ids)),renderReviews(t)}catch{}}function updatePaymentFilter(e){const t=document.getElementById("filter-pay"),n=t.value;t.innerHTML='<option value="all">All Methods</option>',Object.keys(e).sort().forEach(e=>{t.innerHTML+=`<option value="${e}">${e}</option>`}),t.value=n}function getFilteredOrders(){return allOrders.filter(e=>{if("all"!==filterPay){if((e.payment_method||"").toLowerCase()!==filterPay.toLowerCase())return!1}return!0})}function render(){if(!data)return;const e=getFilteredOrders(),t=e.length;let n=e.reduce((e,t)=>e+(t.total_cost||0),0);document.getElementById("s-orders").textContent=t,document.getElementById("s-reviews").textContent=data.total_reviews||0,document.getElementById("s-buyers").textContent=data.unique_buyers||0,document.getElementById("s-revenue").textContent="€"+n.toFixed(2),document.getElementById("c-eur").textContent="€"+(data.revenue_eur||0).toFixed(2),document.getElementById("c-usd").textContent="$"+(data.revenue_usd||0).toFixed(2),document.getElementById("c-rub").textContent="₽"+Math.round(data.revenue_rub||0).toLocaleString(),renderPayments(data.payment_methods||{}),renderProducts(data.top_products||[]),renderBuyers(data.top_buyers||[]),renderOrders(e)}function renderPayments(e){const t=document.getElementById("t-payments"),n=Object.values(e).reduce((e,t)=>e+t,0);if(!n)return void(t.innerHTML='<div class="no-data">No data</div>');const o={Crypto:"#fbbf24",Card:"#818cf8",PayPal:"#3b82f6",SOL:"#fbbf24",BTC:"#f7931a","RU-Card":"#818cf8",Stripe:"#818cf8"};t.innerHTML=Object.entries(e).sort((e,t)=>t[1]-e[1]).map(([e,t])=>`<div class="item"><span class="name">${e}</span><div class="bar"><div class="bar-fill" style="width:${t/n*100}%;background:${o[e]||"#6b7280"}"></div></div><span class="val">${t}</span></div>`).join("")}function renderProducts(e){const t=document.getElementById("t-products");e.length?t.innerHTML=e.map((e,t)=>`<div class="item"><span class="rank ${t<3?["g","s","b"][t]:""}">${t+1}</span><span class="name">${e.name}</span><span class="val">${e.sold} • €${e.revenue.toFixed(2)}</span></div>`).join(""):t.innerHTML='<div class="no-data">No data</div>'}function renderBuyers(e){const t=document.getElementById("t-buyers");e.length?t.innerHTML=e.map((e,t)=>{const n=reviewerIds.has(String(e.id));return`<div class="item"><span class="rank ${t<3?["g","s","b"][t]:""}">${t+1}</span><span class="name ${n?"reviewer":""}">${e.name}</span><span class="val">${e.orders} • €${e.spent.toFixed(2)}</span></div>`}).join(""):t.innerHTML='<div class="no-data">No data</div>'}function renderOrders(e){const t=document.getElementById("o-body");document.getElementById("o-badge").textContent=e.length,e.length?t.innerHTML=e.map((e,t)=>{const n=new Date(e.timestamp),o=n.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})+" "+n.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}),s=(e.payment_method||"Other").toLowerCase().replace(/[^a-z]/g,"");return`<tr><td>#${t+1}</td><td><span class="${reviewerIds.has(String(e.buyer_id))?"reviewer":""}">${e.buyer_name||"?"}</span></td><td class="hm">${e.items_short||"-"}</td><td><span class="pay ${s}">${e.payment_method||"?"}</span></td><td>€${(e.total_cost||0).toFixed(2)}</td><td class="hm">${o}</td><td><button class="vbtn" onclick="showOrder(${t})">View</button></td></tr>`}).join(""):t.innerHTML='<tr><td colspan="7" class="no-data">No orders</td></tr>'}function renderReviews(e){document.getElementById("r-total").textContent=e.total_reviews||0,document.getElementById("r-avg").textContent=e.average_rating||"5.0";const t=document.getElementById("r-list");e.reviews&&e.reviews.length?t.innerHTML=e.reviews.map(e=>{const t=new Date(e.timestamp).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}),n=e.avatar?`<img src="${e.avatar}" alt="">`:e.author[0],o=e.attachments?.length?`<div class="r-imgs">${e.attachments.map(e=>`<img src="${e}" onclick="window.open('${e}')">`).join("")}</div>`:"";return`<div class="r-card">\n            <div class="r-head">\n                <div class="r-ava">${n}</div>\n                <div><div class="r-author">${e.author}</div><div class="r-date">${t}</div></div>\n            </div>\n            <div class="r-stars">${"⭐".repeat(e.stars||5)}</div>\n            <div class="r-text">${e.content}</div>\n            ${o}\n        </div>`}).join(""):t.innerHTML='<div class="no-data">No reviews yet</div>'}function showOrder(e){const t=getFilteredOrders();if(!t[e])return;const n=t[e],o=new Date(n.timestamp).toLocaleString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});let s="";n.items_full?.length&&(s=n.items_full.map(e=>`<div class="m-item"><span>${e.name||"?"}</span><span>x${e.qty||1} • €${((e.price||0)*(e.qty||1)).toFixed(2)}</span></div>`).join(""));const a=reviewerIds.has(String(n.buyer_id))?" ⭐":"";document.getElementById("modal-body").innerHTML=`\n        <h2 class="m-title">Order #${e+1}</h2>\n        <div class="m-row"><span>Buyer</span><span>${n.buyer_name||"?"}${a}</span></div>\n        <div class="m-row"><span>Nickname</span><span>${n.nickname||"N/A"}</span></div>\n        <div class="m-row"><span>Coordinates</span><span>${n.coordinates||"N/A"}</span></div>\n        <div class="m-row"><span>Payment</span><span>${n.payment_method||"N/A"}</span></div>\n        <div class="m-row"><span>Delivery</span><span>${n.delivery_speed||"Default"}</span></div>\n        <div class="m-row"><span>Delivered by</span><span>${n.delivery_person||"N/A"}</span></div>\n        <div class="m-row"><span>Date</span><span>${o}</span></div>\n        <div class="m-row"><span>Total</span><span style="color:#ffb070;font-weight:700">€${(n.total_cost||0).toFixed(2)}</span></div>\n        <div class="m-items"><h4>Items</h4>${s||'<div class="no-data">No items</div>'}</div>`,document.getElementById("modal").classList.add("show")}function closeModal(){document.getElementById("modal").classList.remove("show")}async function createToken(){const e=document.getElementById("tk-name").value.trim()||"Token",t=parseInt(document.getElementById("tk-uses").value)||-1;try{const n=await fetch(API+"/tokens/create",{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({name:e,max_uses:t})}),o=await n.json();o.success&&(document.getElementById("tk-new").textContent=o.token,document.getElementById("tk-done").classList.remove("hide"),loadTokens())}catch{}}function copyToken(){navigator.clipboard.writeText(document.getElementById("tk-new").textContent),document.getElementById("tk-copy").textContent="Copied!",setTimeout(()=>document.getElementById("tk-copy").textContent="Copy",2e3)}async function loadTokens(){if(isAdmin)try{const e=await fetch(API+"/tokens",{headers:{Authorization:"Bearer "+token}}),t=await e.json(),n=document.getElementById("tk-list");if(!t.tokens?.length)return void(n.innerHTML='<div class="no-data">No tokens</div>');n.innerHTML=t.tokens.map(e=>`<div class="tk-item"><div class="info"><div class="name">${e.name}</div><div class="meta">ID: ${e.id} • Uses: ${-1===e.max_uses?"∞":e.current_uses+"/"+e.max_uses}</div></div><button class="del" onclick="delToken('${e.id}')">Del</button></div>`).join("")}catch{}}async function delToken(e){if(confirm("Delete?"))try{await fetch(API+"/tokens/delete",{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({id:e})}),loadTokens()}catch{}}async function loadLogs(){if(isAdmin){try{const e=await fetch(API+"/logs/login",{headers:{Authorization:"Bearer "+token}}),t=await e.json();document.getElementById("log-login").innerHTML=t.logs?.length?t.logs.map(e=>{const t=new Date(e.timestamp);return`<div class="log ${e.success?"success":"error"}"><div class="time">${t.toLocaleString("en-GB",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}</div><div class="msg">${e.token_type} from ${e.ip||"?"} ${e.success?"✓":"✗"}</div></div>`}).join(""):'<div class="no-data">No logs</div>'}catch{}try{const e=await fetch(API+"/logs/bot",{headers:{Authorization:"Bearer "+token}}),t=await e.json();document.getElementById("log-bot").innerHTML=t.logs?.length?t.logs.map(e=>{const t=new Date(e.timestamp);return`<div class="log ${e.level||"info"}"><div class="time">${t.toLocaleString("en-GB",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}</div><div class="msg">${e.message}</div></div>`}).join(""):'<div class="no-data">No logs</div>'}catch{}}}document.addEventListener("DOMContentLoaded",()=>{loader(),document.getElementById("btn-login").onclick=login,document.getElementById("inp-token").onkeypress=e=>"Enter"===e.key&&login(),document.getElementById("logout").onclick=logout,document.getElementById("modal-x").onclick=closeModal,document.getElementById("modal").onclick=e=>"modal"===e.target.id&&closeModal(),document.getElementById("btn-admin").onclick=showAdminForm,document.getElementById("btn-back1").onclick=backToToken,document.getElementById("btn-send").onclick=sendCode,document.getElementById("btn-back2").onclick=()=>{document.getElementById("form-code").classList.add("hide"),document.getElementById("form-pass").classList.remove("hide")},document.getElementById("btn-verify").onclick=verifyCode,document.getElementById("inp-code").onkeypress=e=>"Enter"===e.key&&verifyCode(),document.getElementById("tk-create").onclick=createToken,document.getElementById("tk-copy").onclick=copyToken,document.querySelectorAll("#periods button").forEach(e=>{e.onclick=()=>{document.querySelectorAll("#periods button").forEach(e=>e.classList.remove("active")),e.classList.add("active"),period=e.dataset.p,fetchStats()}}),document.getElementById("filter-pay").onchange=e=>{filterPay=e.target.value,render()},document.getElementById("filter-reset").onclick=()=>{filterPay="all",document.getElementById("filter-pay").value="all",render()},document.querySelectorAll(".tabs button").forEach(e=>{e.onclick=()=>{const t=e.parentElement;t.querySelectorAll("button").forEach(e=>e.classList.remove("active")),e.classList.add("active"),t.parentElement.querySelectorAll(".tab").forEach(e=>e.classList.remove("active")),document.getElementById("t-"+e.dataset.t).classList.add("active")}}),document.querySelectorAll("#nav .nav").forEach(e=>{e.onclick=t=>{t.preventDefault();const n=e.dataset.s;("admin"!==n||isAdmin)&&(document.querySelectorAll("#nav .nav").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".sec").forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.getElementById("sec-"+n).classList.add("active"),"admin"===n&&isAdmin&&(loadTokens(),loadLogs()),document.getElementById("side").classList.remove("open"),document.getElementById("overlay").classList.remove("show"))}}),document.getElementById("menu-btn").onclick=()=>{document.getElementById("side").classList.toggle("open"),document.getElementById("overlay").classList.toggle("show")},document.getElementById("overlay").onclick=()=>{document.getElementById("side").classList.remove("open"),document.getElementById("overlay").classList.remove("show")},setInterval(()=>token&&fetchStats(),3e4)});